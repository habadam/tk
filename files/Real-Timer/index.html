<!DOCTYPE html>
<html ng-app="app" ng-controller="masterCtrl as m" lang="no">
<head>
  <meta charset="utf-8">
  <title>Real-Timer — Den raskeste måten å sjekke når kollektivtransporten kommer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Real-Timer">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png" />
  <link rel="icon" href="assets/favicon.ico">
  <style ng-bind="m.css"></style>
</head>
<body>
  <header>
    <h1>Real-Timer</h1>
  </header>
  <spacer></spacer>

  <div class="content top-padded" ng-if="!m.success" ng-bind="m.status"></div>

  <div class="content no-padding" ng-if="m.success">
    <div ng-repeat="object in m.data track by $index" ng-if="object.PlaceType == 'Stop'" ng-class="{'expanded':object.expanded, 'impanded':!object.expanded}" ng-click="m.toggle($index)">
      <div class="content-row">
        <div ng-bind="object.Name"></div>
        <div ng-click="m.reload(object.ID, $index)" class="glyphicon glyphicon-refresh" ng-if="object.expanded && m.jqLoaded"></div>
        <div class="glyphicon" ng-class="{'glyphicon-chevron-up':object.expanded, 'glyphicon-chevron-down':!object.expanded}"></div>
      </div>
      <iframe id="{{object.ID}}" style="{{'height:'+object.height}}" ng-src="{{'//thorin-apps.tk/cors/widget.php#('+object.ID+')'+object.Name+'%20('+object.District+')'}}"></iframe>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.0/angular.min.js"></script>
  <style>
    body {
      font-family: ubuntu, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      margin: 0;
      background-color: #333;
    }
    header {
      width: 100%;
      background: #FEFEFE;
      margin: auto;
      border: 1px solid #CCC;
      letter-spacing: 1px;
      height: 66px;
      text-align: center;
      z-index: 1000;
    }
    @media screen and (min-height: 570px) {
      header {
        position: fixed;
      }
      spacer {
        display: block;
        height: 66px;
      }
    }
    .impanded>iframe {
      height: 0 !important;
    }
    iframe {
      border: 0;
      height: 0;
      width: 100%;
      max-width: 500px;
      transition: height 0.5s ease-in-out;
    }
    .content {
      width: 85%;
      background: #FEFEFE;
      border: 1px solid #CCC;
      margin: 35px auto;
      padding: 0 11px 0 11px;
      max-width: 500px;
      padding-bottom: 30px;
      border-radius: 15px;
    }
    .top-padded {
      padding-top: 30px;
    }
    .no-padding {
      padding-bottom: 0;
    }
    .content-row {
      display: flex;
      padding: 15px;
      cursor: pointer;
      justify-content: space-between;
    }
    .content-row>* {
      flex: 1;
    }
    .content-row>*:first-child {
      text-align: left;
    }
    .content-row>* {
      text-align: center;
    }
    .content-row>*:last-child {
      text-align: right;
    }
  </style>
  <script>
  let app = angular.module('app', []);

  app.config(["$sceProvider", '$controllerProvider', '$provide', '$sceDelegateProvider', function($sceProvider, $controllerProvider, $provide, $sceDelegateProvider) {
    $sceDelegateProvider.resourceUrlWhitelist([
      'self',
      'http://static.thorin-games.tk/**',
      'https://thorin-apps.tk/**',
      'https://ruter.no/**'
    ]);
    $sceProvider.enabled(true);

    // Provider-based controller.
    app.controller = function( name, constructor ) {
      $controllerProvider.register( name, constructor );
      return( this );
    };
  }]);

  app.controller('masterCtrl', ['$http', '$lazy', '$timeout', function ($http, $lazy, $timeout) {
    let vm = this;
    vm.css = "";
    vm.jqLoaded = false;
    vm.status = "Lokaliserer…";
    vm.success = false;
    vm.errors = {
      unknown: false,
      position: false
    };
    vm.data = [];
    vm.coords = [0,0];
    vm.conv = $lazy.get('assets/converter.min.js').then((data)=>{
      eval(data);
    }).catch((data, status)=>{
      console.log(data,status);
      vm.error = true;
    });

    let geo_success = (position)=>{
      vm.errors.position = false;
      vm.conv.then(()=>{
        vm.coords = convert(position.coords.latitude, position.coords.longitude);
        vm.status = "Laster inn data…";
        console.log(vm.coords);
        $lazy.get('//thorin-apps.tk/cors.php?url=reisapi.ruter.no%2FPlace%2FGetClosestPlacesExtension%3Fcoordinates%3Dx%3D'+Math.round(vm.coords[0])+'%2Cy%3D'+Math.round(vm.coords[1])+'%26proposals%3D12', 0).then(function (data) {
          vm.success = true;
          vm.data = data;
          for (var i = 0; i < vm.data.length; i++) {
            vm.data[i].expanded = false;
            vm.data[i].height = 0;
          }
        }).catch(()=>{
          vm.status = "Kunne ikke laste inn data.";
        });
      });
      $timeout(()=>{
        navigator.geolocation.clearWatch(vm.wpid);
      }, 5000);
    }
    let geo_error = ()=>{
      console.log("Couldn't get position");
      vm.status = "Fikk ikke tilgang til stedstjenester";
      vm.errors.position = true;
    }
    let geo_options = {
      enableHighAccuracy: false,
      maximumAge        : 30000,
      timeout           : 2500
    }
    if ('geolocation' in navigator) {
      vm.wpid = navigator.geolocation.watchPosition(geo_success, geo_error, geo_options);
    } else {
      vm.status = "Fikk ikke tilgang til stedstjenester";
      vm.errors.position = true;
    }
    vm.toggle = (i)=>{
      vm.data[i].expanded = !vm.data[i].expanded;
    };
    vm.reload = (id, i)=>{
      vm.toggle(i);
      $('#'+id).src += "";
    };
    $lazy.get('assets/glyphicons.min.css').then((data)=>{
      vm.css += data;
    });
    vm.jq = $lazy.get('https://code.jquery.com/jquery-3.1.1.min.js');
    vm.jq.then((data)=>{
      eval(data);
      vm.jqLoaded = true;
      let eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
      let eventer = window[eventMethod];
      let messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";
      eventer(messageEvent, function(e) {
        if (typeof e.data === "string" && e.data.indexOf(",")>-1) {
          let id = e.data.split(',')[0];
          let height = e.data.split(',')[1]+"px";
          for (let i = 0; i < vm.data.length; i++) {
            if (vm.data[i].ID == id) {
              $timeout(()=>{
                vm.data[i].height = height;
              }, 0);
            }
          }
        }
      }, false);
    })
  }]);

  app.service('$lazy', ['$http', '$q', '$timeout', function ($http, $q, $timeout) {
    let vm = this;

    vm.get = (url, timeout, options)=>{
      let deferred = $q.defer();
      let resolved = false;
      let request = $http.get(url, options);
      request.success(function (data) {
        if (typeof Storage !== "undefined") {
          try {
            localStorage[url] = JSON.stringify(data);
          } catch (e) {
            console.log("Couldn't save "+url+"-data to storage even though storage exists. Error:",e);
          }
        }
        deferred.resolve(data);
        resolved = true;
      });
      request.error(function (data, status) {
        if (typeof Storage !== "undefined" && url in localStorage) {
          console.info("The request to",url,"failed, but data existed locally");
          deferred.resolve(JSON.parse(localStorage[url]));
          resolved = true;
        } else {
          deferred.reject("ERROR");
        }
      });
      if (typeof timeout !== "undefined") {
        $timeout(function () {
          if (!resolved && typeof Storage !== "undefined" && url in localStorage) {
            deferred.resolve(JSON.parse(localStorage[url]));
            console.info("Timeout reached for",url,"but data existed locally");
          }
        }, timeout);
      }
      return deferred.promise;
    }
  }]);
  </script>

  </body>
  </html>
