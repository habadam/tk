<!DOCTYPE html>
<html ng-app="app" ng-controller="masterCtrl as m" lang="no">
<head>
  <meta charset="utf-8">
  <title>Real-Timer — Den raskeste måten å sjekke når kollektivtransporten kommer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Real-Timer">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png" />
  <link rel="icon" href="assets/favicon.ico">
</head>
<body>
  <header>
    <h1>Real-Timer</h1>
  </header>

  <div class="content" ng-repeat="object in m.data">
    <h6 ng-bind="object.Name"></h6>
    <iframe ng-src="{{'https://ruter.no/iframe-realtime.html#('+object.ID+')'+object.Name+'%20('+object.District+')'}}"></iframe>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.0/angular.min.js"></script>
  <script>
  let app = angular.module('app', []);

  app.controller('masterCtrl', ['$http', '$lazy', '$timeout', function ($http, $lazy, $timeout) {
    let vm = this;
    vm.success = false;
    vm.errors = {
      unknown: false,
      position: false
    };
    vm.data = [];
    vm.coords = [0,0];
    vm.conv = $lazy.get('assets/converter.min.js').then((data)=>{
      eval(data);
    }).catch((data, status)=>{
      console.log(data,status);
      vm.error = true;
    });

    let geo_success = (position)=>{
      vm.errors.position = false;
      vm.conv.then(()=>{
        vm.coords = convert(position.coords.latitude, position.coords.longitude);
        console.log(vm.coords);
        $lazy.get('//thorin.epizy.com/cors.php?url=Place%2FGetClosestPlacesExtension%3Fcoordinates%3Dx%3D'+Math.round(vm.coords[0])+'%2Cy%3D'+Math.round(vm.coords[1])+'%26proposals%3D12', 0, {withCredentials:true}).then(function (data) {
          vm.success = true;
          vm.data = data;
          console.log('Recieved data from Ruter:',data);
        });
      });
      $timeout(()=>{
        navigator.geolocation.clearWatch(vm.wpid);
      }, 5000);
    }
    let geo_error = ()=>{
      console.log("Couldn't get position");
      vm.errors.position = true;
    }
    let geo_options = {
      enableHighAccuracy: false,
      maximumAge        : 30000,
      timeout           : 2500
    }
    if ('geolocation' in navigator) {
      vm.wpid = navigator.geolocation.watchPosition(geo_success, geo_error, geo_options);
    } else {
      vm.errors.position = true;
    }
  }]);

  app.service('$lazy', ['$http', '$q', '$timeout', function ($http, $q, $timeout) {
    let vm = this;

    vm.get = (url, timeout, options)=>{
      let deferred = $q.defer();
      let resolved = false;
      let request = $http.get(url, options);
      request.success(function (data) {
        if (typeof Storage !== "undefined") {
          try {
            localStorage[url] = JSON.stringify(data);
          } catch (e) {
            console.log("Couldn't save "+url+"-data to storage even though storage exists. Error:",e);
          }
        }
        deferred.resolve(data);
        resolved = true;
      });
      request.error(function (data, status) {
        if (typeof Storage !== "undefined" && url in localStorage) {
          console.info("The request to",url,"failed, but data existed locally");
          deferred.resolve(JSON.parse(localStorage[url]));
          resolved = true;
        } else {
          deferred.reject("ERROR");
        }
      });
      if (typeof timeout !== "undefined") {
        $timeout(function () {
          if (!resolved && typeof Storage !== "undefined" && url in localStorage) {
            deferred.resolve(JSON.parse(localStorage[url]));
            console.info("Timeout reached for",url,"but data existed locally");
          }
        }, timeout);
      }
      return deferred.promise;
    }
  }]);
  </script>

  <style>
  body {
    font-family: ubuntu, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  }
  </style>
</body>
</html>
