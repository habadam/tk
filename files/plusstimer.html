<!doctype html>
<html>
<head>
  <title>Plusstimer</title>
  <link href="../assets/standard.css" rel="stylesheet">
  <link rel="icon" href="http://icons.veryicon.com/ico/System/Icons8%20Metro%20Style/Mathematic%20Plus2.ico">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="http://icons.veryicon.com/ico/System/Icons8%20Metro%20Style/Mathematic%20Plus2.ico" />
  <style>
    pre {
      line-height: 1.5;
      font-size: 1em !important;
      white-space: pre-line;
      word-wrap: break-word;
    }
    html {
      min-height: 100%;
      display: flex;
    }
    body {
      min-width:100%;
      display:flex;
      margin:0;
    }
    #caption {
      position: absolute;
      margin: 40px 0 -30px 0;
      width: 200px;
      max-width: 100%;
      color: #aaa;
    }
  </style>
  <script type="text/javascript">
    // Your Client ID can be retrieved from your project in the Google
    // Developer Console, https://console.developers.google.com
    var CLIENT_ID = '1068107389496-sapmb6nh9l85vccdke6ju2jsbv5ibs51.apps.googleusercontent.com';

    var SCOPES = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"];

    var spreadsheetId, spreadSheetName;

    let q = (s)=>{return document.querySelector(s)}

    /**
    * Check if current user has authorized this application.
    */
    function checkAuth() {
      gapi.auth.authorize(
        {
          'client_id': CLIENT_ID,
          'scope': SCOPES.join(' '),
          'immediate': true
        }, handleAuthResult
      );
    }

    /**
    * Handle response from authorization server.
    *
    * @param {Object} authResult Authorization result.
    */
    function handleAuthResult(authResult) {
      var authorizeDiv = document.getElementById('authorize-div');
      if (authResult && !authResult.error) {
        // Hide auth UI, then load client library.
        authorizeDiv.style.display = 'none';
        appendPre('Authorizisation successful');
        loadGDriveApi();
        //loadSheetsApi();
      } else {
        // Show auth UI, allowing the user to initiate authorization by
        // clicking authorize button.
        authorizeDiv.style.display = 'inline';
      }
    }

    /**
    * Initiate auth flow in response to user clicking authorize button.
    *
    * @param {Event} event Button click event.
    */
    function handleAuthClick(event) {
      gapi.auth.authorize(
        {client_id: CLIENT_ID, scope: SCOPES, immediate: false},
        handleAuthResult
      );
      appendPre('Authorizing…');
      return false;
    }

    /**
    * Load Google Drive API library.
    */
    function loadGDriveApi() {
      appendPre('Loading…');
      gapi.client.load('drive', 'v2', findFile);
    }

    /**
    * Find the right file.
    */
    function findFile() {
      appendPre('Finding file…')
      var request = gapi.client.drive.files.list({
        "q": "fullText contains 'Omregning fra klokketimer (60 minutter) til skoletimer (45 minutter) (Summering av fravær i Skolearena er i klokketimer)'"
      });
      request.execute(function(resp) {
        if (!resp.error) {
          console.log(resp);
          spreadsheetId = getID(resp.items);
          if (spreadsheetId) {
            loadSheetsApi()
          }
        } else if (resp.error.code == 401) {
          // Access token might have expired.
          checkAuth();
        } else {
          appendPre('An error occured: ' + resp.error.message);
        }
      });
    }

    /**
    * Find ID of the right file or create a file if none exist and return ID
    */
    function getID(items) {
      for (var i = 0; i < items.length; i++) {
        if (items[i].mimeType == "application/vnd.google-apps.spreadsheet") {
          spreadSheetName = items[i].title;
          return items[i].id;
        }
      }
      appendPre('Du har ikke det nødvendige regnearket på din Google Drive, eller så har du endre for mye på det til at det fungerer.')
      // Generate file on user's drive
    }

    /**
    * Load Sheets API client library.
    */
    function loadSheetsApi() {
      appendPre('Loading…');
      var discoveryUrl =
      'https://sheets.googleapis.com/$discovery/rest?version=v4';
      gapi.client.load(discoveryUrl).then(outputData);
    }

    /**
    * Print the data:
    */
    function outputData() {
      appendPre('Loading file…');
      if (typeof spreadsheetId === 'string' && spreadsheetId.length > 5) {
        console.log("spreadsheetId passed line 100 test. Var-dump:","(",typeof spreadsheetId,")",spreadsheetId);
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: spreadsheetId,
          range: 'Fravær for klassen!G8',
        }).then(function(response) {
          appendPre('Loading completed.');
          var range = response.result;
          if (range.values.length > 0) {
            appendPre('Outputting result…');
            appendPre(range.values[0][0] + 'plusstimer');
            q('#result>number').innerHTML = Number(range.values[0][0]);
            q('#result').style.display = 'block';
            q('#caption').style.display = 'block';
            q('#caption').innerHTML = "Hentet fra regnearket \""+spreadSheetName+"\"";
            q('#output').style.display = 'none';
          } else {
            appendPre('No data found.');
          }
        }, function(response) {
          appendPre('Error: ' + response.result.error.message);
        });
      } else {
        appendPre('Something went wrong, refresh the page and try again');
      }
    }

    /*
    * Oppdater fravær
    */
    var days, hours;
    function updateSheet() {
      q('#output').style.display = 'block';
      appendPre('Oppdaterer fravær…');
      gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: spreadsheetId,
        range: "'Fravær for klassen'!E8:E9",
        valueInputOption: 'USER_ENTERED',
        values: [ [days, hours] ]
      }).then(function (resp) {
        console.log(resp);
        appendPre('Fravær er oppdatert, laster inn plusstimer på nytt…');
        outputData();
      })
    }

    /**
    * Append a pre element to the body containing the given message
    * as its text node.
    *
    * @param {string} message Text to be placed in pre element.
    */
    function appendPre(message) {
      var pre = document.getElementById('output');
      var textContent = document.createTextNode(message + '\n');
      pre.appendChild(textContent);
    }
  </script>
  <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>
</head>
<body>
  <div id="result" style="font-family: fantasy;width: 200px;max-width: 100%;margin: auto;border-radius: 15px;background-color: #222021;color: white;padding: 2em;display:none;">
    <number style="font-size: 8em;display: block;width: 100%;letter-spacing: 20px;"></number>
    <description style="font-size: 1.75em;">plusstimer</description>
    <div id="caption"></div>
  </div>
  <pre id="output"><div id="authorize-div" style="display: none"><span>Authorize access to Google Sheets API</span> <button id="authorize-button" onclick="handleAuthClick(event)">Authorize</button></div></pre>
  <div id="reload" style="display:none"><a href=".">Try again</a><div>
</body>
</html>
